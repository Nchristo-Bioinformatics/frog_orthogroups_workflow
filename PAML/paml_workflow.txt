###for each foreground labeling for PAML, make a directory where you will keep your treefiles###
mkdir /polar_workflow/PAL2NAL/04-TREES_paml_dd   
mkdir /polar_workflow/PAL2NAL/04-TREES_paml_elevation
mkdir /polar_workflow/PAL2NAL/04-TREES_paml_pristi

####put all the unlabeled treefiles from IQTREE that you made from your pep alignments in each directory####
cp foreground_list.txt /polar_workflow/PAL2NAL/04-TREES_paml*
cp 04-TREES_nolabel/*treefile 04-TREES_paml*/

###make sure the foreground list is in your tree dir, then label each of your foreground species with a "#1"####
cat foreground_list.txt | while read -r LINE; do sed -i "s/$LINE/$LINE#1/g" *treefile; done

###for each hypothesis you are going to test with codeml, make a directory###
mkdir pristimantis
ln -s ../04-TREES_paml_pristi/*treefile .
ln -s ../../PAL2NAL/05-NOSTOPS/*nostop.fa .

###run this script to create control files for alt and null hypotheses for each alignment, give it a default tree for now, the species tree from Orthofinder###
perl ../../perl_scripts/run_codeml.pl --tree=SpeciesTree_rooted_node_labels.txt --null --alt --aln_suf=nostop.fa
###replace that default tree in the ctrl files with the right gene tree for each alignment###
for file in *.fa.treefile; do f2=${file%%.fa.treefile}".nuc.nostop.fa.alt.ctl"; f3=${file%%.fa.treefile}".nuc.nostop.fa.null.ctl"; sed -i "s/SpeciesTree_rooted_node_labels.txt/$file/g" $f2; sed -i "s/SpeciesTree_rooted_node_labels.txt/$file/g" $f3; done
###lets also change the control files to put outfiles in the right directories, for ease of management###
mkdir alt/
mkdir null
sed -i 's|outfile = |outfile = alt/|g' *alt.ctl
sed -i 's|outfile = |outfile = null/|g' *null.ctl

screen -S paml
export PATH=/home/nchristo/polar_workflow/PAML/paml4.9j/bin/:$PATH   
###now lets run codeml, dunno how long it will take###
for file in *ctl; do codeml $file; done &
screen -d
